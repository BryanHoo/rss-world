# 设置中心：分类管理 UI / 交互改造（自动保存 + 数量徽标 + 删除确认）设计

日期：2026-02-26  
状态：已确认（Approved）

## TL;DR

- 改造设置中心 `CategoriesSettingsPanel` 的视觉与交互细节，让“分类管理”更清爽、更像设置项，而不是一组松散的输入框。
- 保持“即改即存”行为：重命名仍然在 `onBlur` / `Enter` 时触发保存。
- 每条分类显示该分类下订阅源数量（`Badge`），提升信息密度与可扫读性。
- 删除分类增加二次确认（`AlertDialog`），避免误删；确认文案提示订阅源会自动归到“未分类”。
- 保持现有测试依赖的可访问性标记不变（`aria-label` 与按钮文案），仅调整删除测试流程以适配二次确认。

## 背景

当前设置中心“分类”面板可创建/重命名/删除分类，但视觉层级较弱、行内信息不足且删除无二次确认，容易显得“工具感”强但不精致。

## 目标

- 视觉风格对齐设置中心其它面板（如 `AppearanceSettingsPanel` / `AISettingsPanel`）：
  - 统一的 card 轮廓、分隔线、间距与信息层级
  - 深色/浅色主题下都清晰
- 交互保持轻量与快速：
  - 重命名仍然自动保存（`blur` / `Enter`）
  - 行级保存中/错误提示明确
- 信息更完整：
  - 显示每个分类的订阅源数量徽标
- 防误操作：
  - 删除分类必须二次确认

## 非目标

- 不引入分类拖拽排序 / 批量操作 / 搜索筛选。
- 不调整后端接口与数据结构（仍使用 `/api/categories` 系列接口）。
- 不改变“未分类”的 sentinel 逻辑（仍不允许在此面板编辑/删除“未分类”）。

## 方案（选定）

选定方案 A：将分类面板重构为“设置列表卡片”风格，保持自动保存行为并补齐状态反馈与删除确认。

### 顶部：创建分类（Create）

- 输入 + 主按钮：
  - 输入保持 `aria-label="新分类名称"`，按钮保持文案 `添加分类`（避免测试与可访问性回退）。
  - 支持在输入框内按 `Enter` 触发创建。
  - 创建中按钮禁用，并显示 spinner（`Loader2`）。
  - 错误 `createError` 显示在输入下方（`text-destructive`）。

### 列表：分类行（Rename + Count + Delete）

每行采用更稳定的三列布局：

1) 左侧：分类名称输入（自动保存）

- 输入保持 `aria-label="分类名称-${index}"` 与 `id="category-name-${index}"`。
- 保持 `onBlur` / `Enter` 自动保存。
- 支持 `Escape` 撤销未保存的本地编辑（恢复到原值，不触发请求）。
- 行级 busy 时禁用输入。

2) 中间：订阅源数量 `Badge`

- 基于 `useAppStore().feeds` 统计 `feed.categoryId === category.id` 的数量。
- 始终显示（含 0），便于扫读。

3) 右侧：删除按钮 + 二次确认

- 删除按钮保持 `aria-label="删除分类-${index}"`。
- 点击打开 `AlertDialog`，在对话框中确认后才执行删除请求。
- 对话框描述提示：删除分类不会删除订阅源，订阅源会自动归并到“未分类”。

### 状态反馈

- `rowBusyById[categoryId]`：禁用该行输入与删除按钮，并在操作区显示 spinner。
- `rowErrorById[categoryId]`：输入下方展示错误信息（保持现有文案逻辑）。

## 测试计划

- 更新 `CategoriesSettingsPanel.test.tsx`：
  - “删除分类”从“点击即删除”调整为“点击打开确认弹窗 → 点击确认删除”。
  - 继续依赖并保留：
    - `aria-label="新分类名称"`
    - 按钮文案 `添加分类`
    - 行内输入 `分类名称-0`
    - 删除按钮 `删除分类-0`

## 验收标准

- 分类面板视觉更紧凑、更像设置项列表，且深色/浅色模式对比度良好。
- 创建/重命名/删除流程可用，且重命名仍为自动保存。
- 每条分类可见订阅源数量徽标。
- 删除分类需要二次确认；删除后对应分类从列表移除，并将相关订阅源自动归到“未分类”（前端状态与后端行为一致）。

## 影响范围

- 修改：
  - `src/features/settings/panels/CategoriesSettingsPanel.tsx`
  - `src/features/settings/panels/CategoriesSettingsPanel.test.tsx`
